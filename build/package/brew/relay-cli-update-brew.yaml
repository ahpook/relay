version: v6
description: This workflow issues a PR against puppetlabs/homebrew-puppet to update the version and sha when a new tag is cut on the puppetlabs/relay CLI.
parameters:
  tag:
    description: version number of the new tagged binary
  sha:
    description: sha256 of the macos binary produced by the release build
steps:
  - name: clone-and-edit-pr
    image: projectnebula/core
    spec:
      github_token: !Secret github_token
      tag: !Parameter tag
      sha: !Parameter sha
    input: 
      - |
        GITHUB_TOKEN=$(ni get -p {.github_token})
        TAG=$(ni get -p {.tag})
        SHA=$(ni get -p {.sha})
        if [[ -n $GITHUB_TOKEN ]] && [[ -n $TAG ]] && [[ -n $SHA ]] ; then 
          git clone https://${GITHUB_TOKEN}@github.com/ahpook/homebrew-puppet
          cd homebrew-puppet
          git config user.name "Relay Autobot" && git config user.email "relay@users.noreply.github.com"
          PUBLISH_BRANCH=relay_${TAG}
          git checkout -b ${PUBLISH_BRANCH}
          sed -e "s/version \".*\"/version \"${TAG}\"/g" -i ./Formula/relay.rb
          sed -e "s/sha256 \".*\"/sha256 \"${SHA}\"/g" -i ./Formula/relay.rb
          COMMIT_MESSAGE="Update Relay to tagged version ${TAG}"
          git commit -am "${COMMIT_MESSAGE}"
          git push origin ${PUBLISH_BRANCH}
          PULLS_URI="https://api.github.com/repos/ahpook/homebrew-puppet/pulls"
          AUTH_HEADER="Authorization: token $GITHUB_TOKEN"
          new_pr_resp=$(curl --data "{\"title\": \"${COMMIT_MESSAGE}\", \"head\": \"${PUBLISH_BRANCH}\", \"base\": \"master\"}" -X POST -s -H "${AUTH_HEADER}" ${PULLS_URI})
          echo "$new_pr_resp"
        else
          echo "missing one or more of: tag: [$TAG], sha: [$SHA], token: [sha256:$(sha256sum $GITHUB_TOKEN)]"
        fi

  - name: slack-notify
    image: projectnebula/slack-notification:latest
    spec:
      apitoken:
        $type: Secret 
        name: slack-token
      channel: #team-relay-cli
      message: 
        !Output [clone-and-edit-pr, input]